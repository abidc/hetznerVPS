version: '3.3'
services:
  n8n:
    image: n8nio/n8n:2.1.2
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      TZ: UTC
      N8N_HOST: n8n.abidc.dev
      N8N_PORT: 5678
      N8N_PROTOCOL: https
      WEBHOOK_URL: https://n8n.abidc.dev/
      N8N_EDITOR_BASE_URL: https://n8n.abidc.dev/
      N8N_DIAGNOSTICS_ENABLED: "false"
      N8N_CUSTOM_EXTENSIONS: /home/node/.n8n/custom
    volumes:
      - /srv/stack/data/n8n:/home/node/.n8n
    networks:
      - net_core
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  flowise:
    image: flowiseai/flowise:latest
    restart: unless-stopped
    environment:
      TZ: UTC
      FLOWISE_USERNAME: flowise_admin
      FLOWISE_PASSWORD: "Flowise!2025"
      FLOWISE_FILE_STORAGE_PATH: /root/.flowise/storage
    volumes:
      - /srv/stack/data/flowise:/root/.flowise
    networks:
      - net_core

  openwebui:
    image: ghcr.io/open-webui/open-webui:v0.6.43
    restart: unless-stopped
    volumes:
      - /srv/stack/data/openwebui:/app/backend/data
    networks:
      - net_core
    environment:
      TZ: UTC
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://ollama:11434}
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 384M

  ghost:
    image: ghost:latest
    restart: unless-stopped
    environment:
      TZ: UTC
      url: https://writing.abidc.dev
      database__client: mysql
      database__connection__host: mysql
      database__connection__user: root
      database__connection__password: ${MYSQL_ROOT_PASSWORD:-default_password}
      database__connection__database: ghost
      mail__transport: SMTP
      mail__options__service: Gmail
      mail__options__host: smtp.gmail.com
      mail__options__port: 587
      mail__options__secure: "false"
      mail__options__auth__user: abid.chaudhry@gmail.com
      mail__options__auth__pass: zgrhvnxkjlhaabxe
      mail__from: abid.chaudhry@gmail.com
    volumes:
      - /srv/stack/data/ghost:/var/lib/ghost/content
    networks:
      - net_core

  docmost:
    image: docmost/docmost:latest
    restart: unless-stopped
    environment:
      TZ: UTC
      APP_URL: ${DOCMOST_APP_URL:-http://docmost:3000}
      APP_SECRET: ${DOCMOST_APP_SECRET:-insecure-temporary-key-needs-32chars}
      DATABASE_URL: ${DOCMOST_DATABASE_URL:-postgres://docmost:docmost@postgres:5432/docmost}
      REDIS_URL: ${DOCMOST_REDIS_URL:-redis://redis:6379/0}
    volumes:
      - /srv/stack/data/docmost:/app/data
    networks:
      - net_core
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  linkstack:
    image: linkstackorg/linkstack:latest
    restart: unless-stopped
    environment:
      TZ: UTC
      APP_NAME: ${LINKSTACK_APP_NAME:-LinkStack}
      APP_URL: ${LINKSTACK_APP_URL:-https://links.abidc.dev}
      APP_ENV: ${LINKSTACK_APP_ENV:-production}
      APP_KEY: ${LINKSTACK_APP_KEY:-base64:please-set-me}
      DB_CONNECTION: sqlite
      DB_DATABASE: /htdocs/storage/linkstack.sqlite
    volumes:
      - /srv/stack/data/linkstack:/htdocs/storage
    networks:
      - net_core

  homebox:
    image: sysadminsmedia/homebox:latest
    restart: unless-stopped
    environment:
      TZ: UTC
      HBOX_SECRET_KEY: ${HBOX_SECRET_KEY:-insecure-temporary-key}
      HBOX_ALLOWED_HOSTS: "*"
    volumes:
      - /srv/stack/data/homebox:/data
    networks:
      - net_core
    ports:
      - "7745:7745"

  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml --no-autoupdate run
    volumes:
      - /srv/stack/ops/cloudflared:/etc/cloudflared
    networks:
      - net_core

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    ports:
      - "9443:9443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - net_core

  excalidraw:
    image: excalidraw/excalidraw:latest
    container_name: excalidraw
    restart: unless-stopped
    ports:
      - "3001:80"
    expose:
      - "80"
    networks:
      - net_core


  redis:
    image: redis:alpine
    container_name: paperless-redis
    restart: unless-stopped
    command: ["redis-server", "--requirepass", "${PAPERLESS_REDIS_PASSWORD:-change_me_strong}"]
    networks:
      - net_core

  postgres:
    image: postgres:15-alpine
    container_name: paperless-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: paperless
      POSTGRES_USER: paperless
      POSTGRES_PASSWORD: ${MYSQL_ROOT_PASSWORD:-default_password}
    volumes:
      - /srv/stack/data/paperless/postgres:/var/lib/postgresql/data
    networks:
      - net_core

  paperless:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: paperless
    restart: unless-stopped
    ports:
      - "8001:8000"
    networks:
      - net_core
    volumes:
      - paperless_data:/usr/src/paperless/data
      - paperless_media:/usr/src/paperless/media
    environment:
      PAPERLESS_REDIS: redis://:${PAPERLESS_REDIS_PASSWORD:-change_me_strong}@paperless-redis:6379/0
      PAPERLESS_DBHOST: paperless-postgres
      PAPERLESS_DBPORT: 5432
      PAPERLESS_DBNAME: paperless
      PAPERLESS_DBUSER: paperless
      PAPERLESS_DBPASS: paperless
      PAPERLESS_DBENGINE: postgresql
      # OpenWebUI configuration to connect to Paperless
      PAPERLESS_URL: https://paperless.abidc.dev
      PAPERLESS_CSRF_TRUSTED_ORIGINS: https://paperless.abidc.dev
      PAPERLESS_ALLOWED_HOSTS: paperless.abidc.dev,paperless
    deploy:
      resources:
        limits:
          memory: 384M
        reservations:
          memory: 192M

  wordpress:
    image: wordpress:latest
    restart: unless-stopped
    environment:
      TZ: UTC
      WORDPRESS_DB_HOST: wordpress-mysql
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD:-wordpress_password}
      WORDPRESS_DB_NAME: wordpress
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_HOME', 'https://wordpress.abidc.dev');
        define('WP_SITEURL', 'https://wordpress.abidc.dev');
    volumes:
      - /srv/stack/data/wordpress:/var/www/html
    networks:
      - net_core
    depends_on:
      - wordpress-mysql

  wordpress-mysql:
    image: mysql:8.0
    container_name: wordpress-mysql
    restart: unless-stopped
    environment:
      TZ: UTC
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: ${WORDPRESS_DB_PASSWORD:-wordpress_password}
      MYSQL_ROOT_PASSWORD: ${WORDPRESS_MYSQL_ROOT_PASSWORD:-wordpress_root_password}
    volumes:
      - /srv/stack/data/wordpress-mysql:/var/lib/mysql
    networks:
      - net_core


networks:
  net_core:
    external: true

volumes:
  portainer_data:
  paperless_data:
  paperless_media:
